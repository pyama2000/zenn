---
title: "Web API ã‚µãƒ¼ãƒã‚’ Testcontainers ã¨ Mockall ã§å˜ä½“ãƒ»çµåˆãƒ†ã‚¹ãƒˆã™ã‚‹"
emoji: "ğŸ“‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["rust", "test", "testcontainers", "mock"]
published: true
---

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å¯¾ã—ã¦ CRUD ã®æ“ä½œã‚’ã™ã‚‹ Web API ã‚µãƒ¼ãƒã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã¨ãã«ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ç”¨æ„ã™ã‚‹ã®ã¯ä¸€èˆ¬çš„ã ã¨æ€ã„ã¾ã™ãŒã€ãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ãŸã‚Š Docker Compose ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã® Docker ã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¡ä¸Šã’ã‚‹æ‰‹é–“ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚
ãã“ã§ [Testcontainers](https://testcontainers.com/) ã‚’åˆ©ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰å†…ã§ Docker ã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¡ä¸Šã’ã‚‹ã“ã¨ã§ä½™è¨ˆãªæ‰‹é–“ã‚’çœãæ–¹æ³•ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã™ã€‚
ã¾ãŸã€æœ¬è¨˜äº‹ã§ã¯ Web API ã‚µãƒ¼ãƒã‚’ Rust ã§å®Ÿè£…ã—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’æ¡ç”¨ã—ãŸã®ã§ [Mockall](https://github.com/asomers/mockall) ã§å„å±¤ã®ãƒ¢ãƒƒã‚¯ã‚’ä½œæˆã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã‚‚èª¬æ˜ã—ã¾ã™ã€‚

ä»Šå›è¿½åŠ ã—ãŸãƒ†ã‚¹ãƒˆã®ã‚³ãƒ¼ãƒ‰ã¯ GitHub ã® Pull Request ã«ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚

https://github.com/pyama2000/example-cqrs-event-store/pull/13

# ãŠã•ã‚‰ã„

æœ¬è¨˜äº‹ã§ã¯ [Rust ã§ Event Sourcing ã‚’è©¦ã—ã¦ã¿ãŸ ~ AWS ã®ãƒ–ãƒ­ã‚°ã‚’å‚è€ƒã«æ¨¡å€£ã™ã‚‹ ~](https://zenn.dev/pyama2000/articles/a0f612677b658b) ã§å®Ÿè£…ã—ãŸ Web API ã‚µãƒ¼ãƒã‚’ãƒ™ãƒ¼ã‚¹ã«èª¬æ˜ã™ã‚‹ã®ã§ç”¨èªã‚„ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ§‹æˆã‚’ãŠã•ã‚‰ã„ã—ã¾ã™ã€‚

## ç”¨èª

- é›†ç´„: ãƒ‰ãƒ¡ã‚¤ãƒ³é§†å‹•è¨­è¨ˆã«ãŠã‘ã‚‹ä¸€é€£ã®é–¢é€£ã™ã‚‹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã®ä¸€è²«æ€§ã¨æ•´åˆæ€§ã‚’ä¿ã¤ãŸã‚ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
- ã‚³ãƒãƒ³ãƒ‰: é›†ç´„ã®å†…éƒ¨çŠ¶æ…‹ã‚’å¤–éƒ¨ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«å¿œã˜ã¦å¤‰æ›´ã™ã‚‹ãŸã‚ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
- ã‚¤ãƒ™ãƒ³ãƒˆ: é›†ç´„å†…ã§è¡Œã‚ã‚ŒãŸæ“ä½œ (ã‚³ãƒãƒ³ãƒ‰) ã®çµæœã¨ã—ã¦ã®çŠ¶æ…‹å¤‰æ›´çµæœã‚’è¡¨ç¾ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ§‹æˆ

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¯ `driver` / `app` / `kernel` / `adapter` ã®4å±¤æ§‹é€ ã‚’æ¡ç”¨ã—ã¦ã„ã¦ã€ãã‚Œãã‚Œã®å±¤ã®å½¹å‰²ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

- `driver`: ãƒ«ãƒ¼ã‚¿ãƒ¼ã¨ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ã‚’æ‹…å½“ã™ã‚‹å±¤
- `app`: ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®å±¤ã§é›†ç´„ã¸ã®ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã‚’æ‹…å½“ã™ã‚‹
- `kernel`: ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æ‹…å½“ã™ã‚‹å±¤ã§é›†ç´„ã‚„ã‚¤ãƒ™ãƒ³ãƒˆã€ã‚³ãƒãƒ³ãƒ‰ã‚’å®šç¾©ã™ã‚‹
- `adapter`: é›†ç´„ã‚„ã‚¤ãƒ™ãƒ³ãƒˆã®æ°¸ç¶šåŒ–ã‚’æ‹…å½“ã™ã‚‹å±¤

å„å±¤ã®ä¾å­˜é–¢ä¿‚ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ãŠã‚Šã€ä¸Šä½ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰ä¸‹ä½ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã™ã‚ˆã†ã«ã—ã¦ã€`kernel` ã¨ `adapter` ã¯ä¾å­˜æ€§é€†è»¢ã®åŸå‰‡ (DIP) ã«ã‚ˆã‚Š `adapter` ã®å¤‰æ›´ã«ã‚ˆã‚‹å½±éŸ¿ç¯„å›²ã‚’æœ€å°é™ã«ã—ã¦ã„ã¾ã™ã€‚

```mermaid
flowchart TD
    driver --> app --> kernel
    adapter -- ä¾å­˜æ€§é€†è»¢ã®æ³•å‰‡ --> kernel
```

ãã‚Œãã‚Œã®å±¤ã¯ä¸‹ä½ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰ä¸Šä½ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã›ãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã« Rust ã® [workspace](https://doc.rust-lang.org/book/ch14-03-cargo-workspaces.html) ã§åŒºåˆ‡ã£ã¦ã„ã¾ã™ã€‚

# å˜ä½“ãƒ†ã‚¹ãƒˆ

Testcontainers ã‚„ Mockall ã‚’ä½¿ã£ãŸãƒ†ã‚¹ãƒˆã‚’èª¬æ˜ã™ã‚‹å‰ã«ãƒ†ãƒ¼ãƒ–ãƒ«é§†å‹•ãƒ†ã‚¹ãƒˆã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã™ã€‚
ãƒ†ãƒ¼ãƒ–ãƒ«é§†å‹•ãƒ†ã‚¹ãƒˆã¨ã¯ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã§ç®¡ç†ã™ã‚‹ãƒ†ã‚¹ãƒˆæ‰‹æ³•ã§ã€å„ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã¯å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã¨æœŸå¾…ã•ã‚Œã‚‹çµæœã®ãƒšã‚¢ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ã¯ãƒ†ãƒ¼ãƒ–ãƒ«å†…ã®å„ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’åå¾©å‡¦ç†ã—ã€å®Ÿéš›ã®çµæœã‚’æœŸå¾…ã•ã‚Œã‚‹çµæœã¨æ¯”è¼ƒã—ã¾ã™ã€‚Rust ã§ã¯ãƒ†ãƒ¼ãƒ–ãƒ«é§†å‹•ãƒ†ã‚¹ãƒˆã¯ä¸€èˆ¬çš„ã§ã¯ãªã„ã¨æ€ã„ã¾ã™ãŒã€ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã§ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ç®¡ç†ã™ã‚‹ã“ã¨ã§ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®ä½œæˆãƒ»ç·¨é›†ãƒ»ç®¡ç†ãŒå®¹æ˜“ã«ãªã‚Šã¾ã™ã€‚ã¾ãŸã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãŒæ§‹é€ åŒ–ã•ã‚Œã¦ã„ã‚‹ãŸã‚ãƒ†ã‚¹ãƒˆã®å†…å®¹ãŒæ˜ç¢ºã«ãªã‚Šã€ãƒ†ã‚¹ãƒˆã®å¯èª­æ€§ãŒå‘ä¸Šã™ã‚‹ã¨æ€ã„ã¾ã™ã€‚

ä¸‹è¨˜ã®ã‚³ãƒ¼ãƒ‰ã¯ `AggregateError` ã‹ã‚‰ `WidgetServiceError` ã«å¤‰æ›ã™ã‚‹å‡¦ç†ã®ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã§ã™ã€‚

https://github.com/pyama2000/example-cqrs-event-store/blob/fddee2cbefa26c9c73d5094b31cf23aac46d3786/internal/app/src/lib.rs#L210-L230

`TestCase` æ§‹é€ ä½“ã¯ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’è¡¨ç¾ã—ã€`error` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’ã€`assert` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å¼•æ•°ã«å¤‰æ›å¾Œã®å€¤ã‚’ `error` ã‚’å—ã‘å–ã£ã¦æœŸå¾…ã™ã‚‹çµæœã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚

## Testcontainers ã‚’ä½¿ã£ãŸãƒ†ã‚¹ãƒˆ

å®Ÿè£…ã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ [SQLx](https://github.com/launchbadge/sqlx) ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ (MySQL) ã¨ã‚„ã‚Šå–ã‚Šã—ã¾ã™ãŒã€ SQLx ã«ã¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã«ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ãŸã‚Šãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ãƒ¼ã‚’å®Ÿè¡Œã—ãŸã‚Šã™ã‚‹ [sqlx::test](https://docs.rs/sqlx/latest/sqlx/attr.test.html) ã¨ã„ã†ä¾¿åˆ©ãª Attribute Macro ãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ã“ã¡ã‚‰ã‚’åˆ©ç”¨ã™ã‚‹ã¨ã„ã„ã§ã—ã‚‡ã†ã€‚ã—ã‹ã—ã€ã‚†ãã‚†ãã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ Amazon DynamoDB ã«å¤‰ãˆã‚‹äºˆå®šãªã®ã§æ¥µåŠ› SQLx ã«ä¾å­˜ã—ãªã„ãƒ†ã‚¹ãƒˆã‚’æ›¸ããŸã‚ã«ä»Šå›ã¯ Testcontainers ã§ Docker ã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦ç«‹ã¡ä¸Šã’ãŸãƒ†ã‚¹ãƒˆç”¨ã® MySQL ã«å¯¾ã—ã¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

ã¨ã„ã£ã¦ã‚‚ä¸‹è¨˜ã®ã‚ˆã†ã«ãŸã£ãŸ2è¡Œã§ Testcontainers ã§ MySQL ã‚³ãƒ³ãƒ†ãƒŠãŒç«‹ã¡ä¸ŠãŒã‚Šã€ã‚³ãƒ³ãƒ†ãƒŠã«æ¥ç¶šã™ã‚‹ãŸã‚ã®ãƒãƒ¼ãƒˆã¯ [testcontainers::core::Container::get_host_port_ipv4](https://docs.rs/testcontainers/latest/testcontainers/core/struct.Container.html#method.get_host_port_ipv4) é–¢æ•°ã§å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

https://github.com/pyama2000/example-cqrs-event-store/blob/fddee2cbefa26c9c73d5094b31cf23aac46d3786/internal/adapter/src/repository.rs#L262-L263

ã‚ã¨ã¯ MySQL ã«æ¥ç¶šã—ã¦ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æº–å‚™ã¯å®Œäº†ã§ã™ã€‚

https://github.com/pyama2000/example-cqrs-event-store/blob/fddee2cbefa26c9c73d5094b31cf23aac46d3786/internal/adapter/src/repository.rs#L264-L278

å®Ÿéš›ã«é›†ç´„ã®ä½œæˆã‚’æ°¸ç¶šåŒ–ã™ã‚‹é–¢æ•° ( `create_widget_aggregate` ) ã‚’ä¾‹ã«èª¬æ˜ã—ã¾ã™ã€‚ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®é–¢æ•°ã®å®Ÿè£…ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

https://github.com/pyama2000/example-cqrs-event-store/blob/fddee2cbefa26c9c73d5094b31cf23aac46d3786/internal/adapter/src/repository.rs#L38-L59

ã“ã®é–¢æ•°ã§ã¯é›†ç´„ã«ä½œæˆã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸçµæœã‚’ Aggregate ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ°¸ç¶šåŒ–ã™ã‚‹é–¢æ•°ãªã®ã§ã€ä½œæˆã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œçµæœã‚’å¼•æ•°ã«å—ã‘å–ã£ãŸå ´åˆã¯

- é–¢æ•°ãŒæˆåŠŸã™ã‚‹
- Aggregate ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ°¸ç¶šåŒ–ã•ã‚Œã‚‹é›†ç´„ã¯1ãƒ¬ã‚³ãƒ¼ãƒ‰
- ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ãã‚Œãã‚Œã®ã‚«ãƒ©ãƒ ã«æ„å›³ã—ãŸå€¤ãŒå…¥ã£ã¦ã„ã‚‹

ã¨ã„ã£ãŸã“ã¨ã‚’ãƒ†ã‚¹ãƒˆã§ããŸã‚‰è‰¯ã„ã§ã—ã‚‡ã†ã€‚ä»¥ä¸‹ãŒãƒ†ã‚¹ãƒˆé–¢æ•°å†…ã§ `TestCase` æ§‹é€ ä½“ã®å®šç¾©ã¨ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®å®šç¾©ã€ãã‚Œã‚’ã‚‚ã¨ã«ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹å‡¦ç†ã§ã™ã€‚

https://github.com/pyama2000/example-cqrs-event-store/blob/fddee2cbefa26c9c73d5094b31cf23aac46d3786/internal/adapter/src/repository.rs#L280-L338

`TestCase` æ§‹é€ ä½“ã® `assert` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å†…ã§ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ãŸã‚ã« SQLx ã‚’åˆ©ç”¨ã—ã¾ã™ãŒã€async ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ãƒ¼ã¯ã¾ã  [å®‰å®šç‰ˆã§ã¯åˆ©ç”¨ã§ããªã„](https://github.com/rust-lang/rust/issues/62290) ã®ã§

https://github.com/pyama2000/example-cqrs-event-store/blob/fddee2cbefa26c9c73d5094b31cf23aac46d3786/internal/adapter/src/repository.rs#L182-L186

ã®ã‚ˆã†ã« `std::future::Future` ã‚’ `std::boxed::Box` ã§åŒ…ã‚“ã§ã€ã•ã‚‰ã« await ã‚’å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã« `std::pin::Pin` ã§åŒ…ã‚“ã ã‚‚ã®ã‚’è¿”ã™é–¢æ•°ã‚’å‹ã¨ã—ã¦å®šç¾©ã—ã¾ã™ã€‚`assert` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å ( `name` ) ã¨ `create_widget_aggregate` é–¢æ•°ã®è¿”ã‚Šå€¤ ( `result` ) ã€SQLx ã§åˆ©ç”¨ã™ã‚‹ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¼ãƒ« ( `pool` ) ã‚’å¼•æ•°ã«å–ã‚Šã€ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ãƒ¼å†…ã§ãã‚Œã‚‰ã‚’åˆ©ç”¨ã—ã¦é–¢æ•°ãŒæ„å›³ã—ãŸæŒ™å‹•ã‚’å–ã‚‹ã‹ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚

## Mockall ã‚’ä½¿ã£ãŸãƒ†ã‚¹ãƒˆ

Mockall ã¯ Trait ã‚„æ§‹é€ ä½“ã®æŒ¯ã‚‹èˆã„ã‚’ãƒ¢ãƒƒã‚¯ã™ã‚‹ãŸã‚ã® crate ã§ã™ã€‚ä»Šå›ã¯ `kernel` ã«å®šç¾©ã—ãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ“ä½œã™ã‚‹æŒ¯ã‚‹èˆã„ã‚’å®šç¾©ã—ãŸ `CommandProcessor` ã‚’ä¾‹ã«ãƒ¢ãƒƒã‚¯ã®ä½œæˆã¨åˆ©ç”¨æ–¹æ³•ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

https://github.com/pyama2000/example-cqrs-event-store/blob/fddee2cbefa26c9c73d5094b31cf23aac46d3786/internal/kernel/src/processor.rs#L7-L23

### ãƒ¢ãƒƒã‚¯ã®ä½œæˆ

`CommandProcessor` ã®ãƒ¢ãƒƒã‚¯ã‚’ãŸã ä½œæˆã™ã‚‹ãªã‚‰

```rust:kernel/src/processor.rs
#[mockall::automock]
pub trait CommandProcessor {
    ...
}
```

ã®ã‚ˆã†ã« [mockall::automock](https://docs.rs/mockall/latest/mockall/attr.automock.html) Attribute Macro ã‚’ Trait ã«è¿½åŠ ã™ã‚‹ã ã‘ã§è‡ªå‹•ã§ãƒ¢ãƒƒã‚¯ç”¨ã®ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¦ãã‚Œã¾ã™ã€‚ã—ã‹ã—ã€ã“ã®ã¾ã¾ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹ã¨ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã«ãƒ¢ãƒƒã‚¯ã®ã‚³ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã—ã¾ã†ãŸã‚ã‚µã‚¤ã‚ºãŒå¢—ãˆã¦ã—ã¾ã„ã¾ã™ã€‚ãã“ã§ã€[cfg_attr](https://doc.rust-lang.org/reference/conditional-compilation.html#the-cfg_attr-attribute) Attribute ã‚’åˆ©ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆæ™‚ã®ã¿ãƒ¢ãƒƒã‚¯ã‚’ä½œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```rust:kernel/src/processor.rs
#[cfg_attr(test, mockall::automock)]
pub trait CommandProcessor {
    ...
}
```

ã“ã‚Œã§ `kernel` crate ã® `CommandProcessor` ã®ãƒ¢ãƒƒã‚¯ã‚’ `app` crate ã‹ã‚‰å‘¼ã³å‡ºã›ã‚‹ã¨æ€ã„ãã‚„ã€ [test](https://doc.rust-lang.org/reference/attributes/testing.html#the-test-attribute) Attribute ã¯åŒä¸€ crate å†…ã§ã—ã‹æ©Ÿèƒ½ã—ãªã„ãŸã‚ä»Šå›ã®ã‚ˆã†ã« workspace ã§åŒºåˆ‡ã£ã¦ã„ãŸå ´åˆã¯åˆ¥ crate ã‹ã‚‰ãƒ¢ãƒƒã‚¯ã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚ãªã®ã§ä»Šå›ã¯ [features ã® Optional Dependencies](https://doc.rust-lang.org/cargo/reference/features.html#optional-dependencies) ã§ `app` crate ã‹ã‚‰ãƒ¢ãƒƒã‚¯ã‚’å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

`kernel` crate ã® Cargo.toml ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã—ã¦

```toml:kernel/Cargo.toml
[dependencies]
mockall = { version = "0.12.1", optional = true }

[features]
mockall = ["dep:mockall"]
```

`CommandProcessor` ã¯ cfg_attr ã§ `mockall` feature ã®ã¨ãã®ã¿ `mockall::automock` ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```rust:kernel/src/processor.rs
#[cfg_attr(feature = "mockall", mockall::automock)]
pub trait CommandProcessor {
    ...
}
```

ãã—ã¦ `app` crate ã® Cargo.toml ã¯ä»¥ä¸‹ã®ã‚ˆã†ã« `dev-dependencies` ã§ `mockall` feature ã‚’æœ‰åŠ¹ã«ã—ã¦ä¾å­˜é–¢ä¿‚ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ãƒ†ã‚¹ãƒˆæ™‚ã®ã¿ãƒ¢ãƒƒã‚¯ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§ãã¾ã™ã€‚

```toml:app/Cargo.toml
[dev-dependencies]
kernel = { path = "../kernel", features = ["mockall"] }
```

### ãƒ¢ãƒƒã‚¯ã‚’åˆ©ç”¨ã™ã‚‹

`mockall::automock` ã«ã‚ˆã£ã¦ `CommandProcessor` ã« `MockCommandProcessor` ãŒç”Ÿæˆã•ã‚Œã€å„é–¢æ•°ã« `expect_` ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãŒä»˜ã„ãŸé–¢æ•°ã‚’å‘¼ã³å‡ºã—ã€ä»¥ä¸‹ã®ã‚ˆã†ã« `returning` é–¢æ•°ã§æŒ¯ã‚‹èˆã„ã‚’ãƒ¢ãƒƒã‚¯ã§ãã¾ã™ã€‚

https://github.com/pyama2000/example-cqrs-event-store/blob/fddee2cbefa26c9c73d5094b31cf23aac46d3786/internal/app/src/lib.rs#L276-L279

ä»–ã«ã‚‚ [with](https://docs.rs/mockall/latest/mockall/examples/__mock_MockFoo_Foo/__foo/struct.Expectation.html#method.with) ã‚„ [withf](https://docs.rs/mockall/latest/mockall/examples/__mock_MockFoo_Foo/__foo/struct.Expectation.html#method.withf)ã€[withf_st](https://docs.rs/mockall/latest/mockall/examples/__mock_MockFoo_Foo/__foo/struct.Expectation.html#method.withf_st) ã®é–¢æ•°ã‚’åˆ©ç”¨ã—ã¦ãƒ¢ãƒƒã‚¯ã—ãŸé–¢æ•°ã®å¼•æ•°ã‚’ãƒ†ã‚¹ãƒˆã§ããŸã‚Šã€

https://github.com/pyama2000/example-cqrs-event-store/blob/fddee2cbefa26c9c73d5094b31cf23aac46d3786/internal/app/src/lib.rs#L249-L263

[never](https://docs.rs/mockall/latest/mockall/examples/__mock_MockFoo_Foo/__foo/struct.Expectation.html#method.never) ã‚„ [once](https://docs.rs/mockall/latest/mockall/examples/__mock_MockFoo_Foo/__foo/struct.Expectation.html#method.once)ã€[times](https://docs.rs/mockall/latest/mockall/examples/__mock_MockFoo_Foo/__foo/struct.Expectation.html#method.times) é–¢æ•°ã§å‘¼ã³å‡ºã—å›æ•°ã‚’ãƒ†ã‚¹ãƒˆã§ããŸã‚Šã™ã‚‹ã®ã§ãœã² [User Guide](https://docs.rs/mockall/latest/mockall/index.html#user-guide) ã‚’å‚è€ƒã«ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

https://github.com/pyama2000/example-cqrs-event-store/blob/fddee2cbefa26c9c73d5094b31cf23aac46d3786/internal/app/src/lib.rs#L344-L356

# çµåˆãƒ†ã‚¹ãƒˆ

çµåˆãƒ†ã‚¹ãƒˆã¯ç«‹ã¡ä¸Šã’ãŸ API ã‚µãƒ¼ãƒã«å¯¾ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã—ã¦æœŸå¾…ã—ãŸæŒ™å‹•ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã€æ°¸ç¶šåŒ–ã®å˜ä½“ãƒ†ã‚¹ãƒˆã¨åŒæ§˜ Testcontainers ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚
Testcontainers ã§ MySQL ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¡ä¸Šã’ã‚‹ã®ã¯åŒæ§˜ã®ãŸã‚å‰²æ„›ã—ã¦ API ã‚µãƒ¼ãƒã‚’ç«‹ã¡ä¸Šã’ã‚‹éƒ¨åˆ†ã«ã¤ã„ã¦èª¬æ˜ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

https://github.com/pyama2000/example-cqrs-event-store/blob/fddee2cbefa26c9c73d5094b31cf23aac46d3786/tests/integration_test.rs#L129-L138

ä¸Šè¨˜ã®ã‚ˆã†ã«ã‚µãƒ¼ãƒãƒ¼ã‚’åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§ç«‹ã¡ä¸Šã’ã¦ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã‚ã‚‹ `/healthz` ãŒãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ã¾ã§ãƒ«ãƒ¼ãƒ—ã—ã¾ã™ã€‚ãã®å¾Œä»–ã®å˜ä½“ãƒ†ã‚¹ãƒˆåŒæ§˜ `TestCase` æ§‹é€ ä½“ã§ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ä½œæˆã—ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

ä»Šå›ã¯åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§ API ã‚µãƒ¼ãƒã‚’ç«‹ã¡ä¸Šã’ã¾ã—ãŸãŒã€axum ã® [Router](https://docs.rs/axum/latest/axum/struct.Router.html) ã® `oneshot` é–¢æ•°ã‚’åˆ©ç”¨ã—ã¦ç›´æ¥ Router ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ ( [axum/examples/testing/src/main.rs](https://github.com/tokio-rs/axum/blob/b03f6c1184723bdc079215222fc168ef96847dea/examples/testing/src/main.rs#L68-L82) )

# ã¾ã¨ã‚

Testcontainers ã‚’åˆ©ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰å†…ã§ Docker ã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¡ä¸Šã’ã¦ãƒ†ã‚¹ãƒˆã«åˆ©ç”¨ã™ã‚‹æ–¹æ³•ã¨ã€Mockall ã§å„å±¤ã®ãƒ¢ãƒƒã‚¯ã‚’ä½œæˆã—ã¦ãƒ†ã‚¹ãƒˆã«åˆ©ç”¨ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã—ãŸã€‚ãƒ†ã‚¹ãƒˆãŒæœ‰ã‚‹ã®ã¨ç„¡ã„ã®ã§ã¯é–‹ç™ºã®é€²ã‚æ–¹ãŒã‹ãªã‚Šé•ã†ã¨æ€ã†ã®ã§ã©ãªãŸã‹ã®å‚è€ƒã«ãªã‚Œã°ã¨æ€ã„ã¾ã™ã€‚

æ¬¡å›ã¯ OpenTelemetry ã¨ OpenObserve ã‚’åˆ©ç”¨ã—ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å¯è¦–åŒ–ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚
